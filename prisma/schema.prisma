// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@internal/prisma/smartg4"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Priority {
  LOW
  NORMAL
  HIGH
}

type DeviceNode {
  NodeClass     String
  Name          String
  AmpRating     Float?
  VoltRating    Float?
  WattRating    Int?
}

type DeviceNodeState {
  State         Boolean?             // for power on/off, sensor detection
  StatusValue   Int?                 // 0 - 100 powered state. e. g. dimmer, motor
  AmpereValue   Int?
  VoltageValue  Int?
  WattPower     Int?
}

model User {
  Id                String              @id @default(auto()) @map("_id") @db.ObjectId
  Username          String
  Email             String?
  FirstName         String?
  LastName          String?
  Password          String
  Disabled          Boolean?
  Archived          Boolean?
  CreatedOn         DateTime
  ArchivedOn        DateTime?
  LoginKey          String?
  LoginKeyExpireOn  DateTime?

  Sessions      UserSession[]
}

model UserSession {
  SessionId     String              @id @default(auto()) @map("_id") @db.ObjectId
  UserId        String              @db.ObjectId
  User          User                @relation(fields: [UserId], references: [Id], onDelete: Cascade)
  UserIp        String  
  LoginOn       DateTime
  ExpireOn      DateTime  
}

model DeviceType {
  Id            Int                 @id @map("_id")
  DeviceCode    String 
  DeviceDesc    String

  NetDevices    NetworkDevice[]
}

model DeviceTypeNode {
  Id            String              @id @map("_id")
  Channel       Int?
  NodeInfo      DeviceNode

  NetworkChannels NetworkChannel[]
}

model Area {
  Id            String              @id @default(auto()) @map("_id") @db.ObjectId
  Name          String
  Details       String?
  
  ParentAreaId  String?             @db.ObjectId
  ParentArea    Area?               @relation(name: "ParentSubArea", fields: [ParentAreaId], references: [Id], onDelete: NoAction, onUpdate: NoAction)

  SubAreas      Area[]              @relation(name: "ParentSubArea")

  NetworkChannels NetworkChannel[]

  CreatedOn     DateTime
  UpdatedOn     DateTime
  CreatedBy     String
  UpdatedBy     String
}

model NetworkBroadcaster {
  Id            String              @id @map("_id") // IP Address
  Name          String?

  AllowDevicesByDefault Boolean     @default(true)

  Enabled       Boolean             @default(false)
  EnabledOn     DateTime?
  EnabledBy     String?
  DisabledOn    DateTime?
  DisabledBy    String?

  DetectedOn    DateTime
  LastMsgOn     DateTime?

  NetworkDevices NetworkDevice[]
}

model NetworkDevice {
  Id            String              @id @map("_id")
  Enabled       Boolean             @default(false)

  EnabledOn     DateTime?
  EnabledBy     String?
  DisabledOn    DateTime?
  DisabledBy    String?

  DeviceId      Int
  DeviceType    DeviceType          @relation(fields: [DeviceId], references: [Id], onDelete: Cascade)

  BroadcasterId String              
  NetworkBroadcaster      NetworkBroadcaster      @relation(fields: [BroadcasterId], references: [Id], onDelete: NoAction, onUpdate: NoAction)

  CustomDesc    String

  Channels      NetworkChannel[]
}

model NetworkChannel {
  Id            String              @id @default(auto()) @map("_id") @db.ObjectId

  NodeTypeId    String              
  NodeType      DeviceTypeNode      @relation(fields: [NodeTypeId], references: [Id], onDelete: NoAction, onUpdate: NoAction)

  CustomDesc    String?

  AreaId        String?             @db.ObjectId
  Area          Area?               @relation(fields: [AreaId], references: [Id], onDelete: Cascade)

  NetworkDevId  String              
  NetworkDevice NetworkDevice       @relation(fields: [NetworkDevId], references: [Id], onDelete: Cascade)

  LastStateId   String?             // refer to NodeStatus.Id
}

model NodeStatus {
  Id            String              @id @map("_id") // composite ID by device/channel/time
  Time          DateTime              // UTC value of millisec
  State         DeviceNodeState
}

type SmartG4Address {
  SubnetId        Int
  DeviceId        Int
}

enum SystemFilterAction {
  ACCEPT
  REJECT
  PENDING
}

model SystemFilter {
  Id              String              @id @default(auto()) @map("_id") @db.ObjectId
  RuleName        String?
  OrderNo         Int
  Ip              String
  DeviceId        String?
  SubnetId        String?
  FilterAction    SystemFilterAction
}

model IncomingMsg {
  Id              String              @id @map("_id")
  TimeReceived    BigInt
  SenderIp        String
  DeviceType      Int
  OriginDevice    SmartG4Address
  OpCode          Int 
  TargetDevice    SmartG4Address
  ContentLen      Int
  Content         Int[]
}

model OutgoingMsg {
  Id              String              @id @map("_id")
  TimeReceived    BigInt
  OpCode          Int
  TargetDevice    SmartG4Address
  ContentLen      Int
  Content         Bytes
  CRCH            Int
  CRCL            Int 
  Priority        Priority            @default(NORMAL)
}
